<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Electricity Tracker - GramVikas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { border: none; }
  </style>
</head>
<body style="background-color: #f6e5c0;">

  <!-- Header -->
  <header class="p-3 shadow-sm" style="background-color: #3e000f;">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img src="Resources/Images/logo.png" alt="GramVikas Logo" height="50" width="100">
        <h4 class="ms-3 text-white fw-bold">GramVikas - Electricity Tracker</h4>
      </div>
      <div>
        <a href="index.html" class="btn btn-outline-light btn-sm">Home</a>
        <div id="google_translate_element" class="d-inline-block ms-3"></div>
      </div>
    </div>
  </header>

  <main class="container my-4">
    <div class="row g-4">
      <!-- Report Form -->
      <div class="col-lg-6 mx-auto">
        <div class="card shadow-sm p-3">
          <h5 class="card-title">Report Electricity Status</h5>
          <form id="reportForm">
            <div class="mb-3">
              <label for="area" class="form-label">Select Area</label>
              <select id="area" class="form-select" required>
                <option value="">-- Select area --</option>
                <option value="Budaun">Budaun</option>
                <option value="Shahjahanpur">Shahjahanpur</option>
                <option value="Sitapur">Sitapur</option>
                <option value="Bahraich">Bahraich</option>
                <option value="Balrampur">Balrampur</option>
                <option value="Gonda">Gonda</option>
                <option value="Barabanki">Barabanki</option>
                <option value="Hardoi">Hardoi</option>
                <option value="Lakhimpur Kheri">Lakhimpur Kheri</option>
                <option value="Farrukhabad">Farrukhabad</option>
                <option value="Etah">Etah</option>
                <option value="Kasganj">Kasganj</option>
                <option value="Mainpuri">Mainpuri</option>
                <option value="Basti">Basti</option>
                <option value="Sant Kabir Nagar">Sant Kabir Nagar</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Current status</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="status" id="statusAvailable" value="available" checked>
                <label class="form-check-label" for="statusAvailable">Electricity available</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="status" id="statusOutage" value="outage">
                <label class="form-check-label" for="statusOutage">No electricity (Outage)</label>
              </div>
            </div>

            <div class="mb-3">
              <label for="notes" class="form-label">Optional notes</label>
              <textarea id="notes" class="form-control" rows="2" placeholder="Any extra details"></textarea>
            </div>

            <div class="mb-3">
              <strong>Current outage reports for this area: </strong>
              <span id="outageCount">Select an area</span>
            </div>

            <button class="btn btn-primary w-100" type="submit">Submit Report</button>
            <div id="formMsg" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <section id="footer" style="background-color: #490600; color: #f7e9d6;">
    <div class="container justify-content-between">
      <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my-5 border-top border-light">
        <div class="col mb-3">
          <img src="Resources/Images/logo.png" width="150" alt="">
        </div>
        <div class="col mb-3"></div>
        <div class="col mb-3">
          <h5>Section</h5>
          <ul class="nav flex-column">
            <li><a href="#" class="nav-link p-0" style="color: #f7e9d6;">Home</a></li>
            <li><a href="#" class="nav-link p-0" style="color: #f7e9d6;">Citizen</a></li>
            <li><a href="#" class="nav-link p-0" style="color: #f7e9d6;">Admin</a></li>
            <li><a href="#" class="nav-link p-0" style="color: #f7e9d6;">About</a></li>
          </ul>
        </div>
        <div class="col mb-3"></div>
        <div class="col mb-3">
          <h5>Contact Us</h5>
          <p>IIM Rohtak<br>NH-10 Southern Bypass, Sunaria,<br>Rohtak-124010 Haryana, India</p>
        </div>
      </footer>
      <div class="d-flex flex-column flex-sm-row justify-content-between py-4 my-4 border-top border-light">
        <p>©️ 2025 GramVikas. All Rights Reserved.</p>
      </div>
    </div>
  </section>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCV3QnZec1y3rdOCJXHUQBzqMd0-XqolQo",
      authDomain: "electricity-trackergv.firebaseapp.com",
      projectId: "electricity-trackergv",
      storageBucket: "electricity-trackergv.firebasestorage.app",
      messagingSenderId: "597831316022",
      appId: "1:597831316022:web:3f2ef65d608d518fad1e97"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const FLAG_THRESHOLD = 1;

    const areaSelect = document.getElementById('area');
    const outageCountEl = document.getElementById('outageCount');
    let unsubscribeListener = null;

    // Real-time outage count
    areaSelect.addEventListener('change', () => {
      const area = areaSelect.value;
      if (unsubscribeListener) unsubscribeListener(); // remove old listener
      if (!area) {
        outageCountEl.textContent = "Select an area";
        return;
      }

      unsubscribeListener = db.collection('reports')
        .where('area', '==', area)
        .where('status', '==', 'outage')
        .onSnapshot(snapshot => {
          outageCountEl.textContent = snapshot.size;
        });
    });

    // Handle report submission
    const form = document.getElementById('reportForm');
    const msg = document.getElementById('formMsg');

    form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.innerHTML = '';

  const area = document.getElementById('area').value;
  const status = document.querySelector('input[name="status"]:checked').value;
  const notes = document.getElementById('notes').value.trim();

  if (!area) {
    msg.innerHTML = '<div class="text-danger">Please select an area.</div>';
    return;
  }

  try {
    await db.collection('reports').add({
      area,
      status,
      notes,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // New code: count outage reports for this area and update outages collection accordingly
    if (status === 'outage') {
      const snapshot = await db.collection('reports')
        .where('area', '==', area)
        .where('status', '==', 'outage')
        .get();

      const outageCount = snapshot.size;

      if (outageCount >= FLAG_THRESHOLD) {
        await db.collection('outages').doc(area).set({
          count: outageCount,
          verified: false,
          lastReportedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    if (status === 'outage') {
      msg.innerHTML = ⁠ <div class="text-warning">⚠ Outage reported in ${area}. Thank you for your report.</div> ⁠;
    } else {
      msg.innerHTML = '<div class="text-success">Thank you — your report has been submitted.</div>';
    }

    form.reset();
  } catch (err) {
    console.error(err);
    msg.innerHTML = '<div class="text-danger">Failed to submit — try again later.</div>';
  }
});
</script>

  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'hi',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>
